<!DOCTYPE html>
<html>
  <head>
      <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"></script>
     
      <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>    

  </head>
  <body>
    <input id="username" type="text"></input>
    <button id="logar_btn" onclick="iniciar()">Iniciar</button>

      <div style="height:80vh;width:100vw;">
          <div id="chat" style="height:100%;">      
            </div>
            <input id="message" type="text" disabled></input>
            <button id="enviar" disabled>Enviar</button>
      </div>
    
    <script>
      var usuario;

function iniciar(){
  (async () => {
  const user = document.getElementById('username').value;
  if(!user){
    alert('Insert a username');
    return;
  }
  const rawResponse = await fetch("https://chatdojiko.herokuapp.com/login?user=" + user, {
  method: 'GET',
  headers: {
    'Accept': 'application/json',
    'Content-Type': 'application/json'
  }      
});
const content = await rawResponse.json();
console.log(content);
if(content.error){
  alert('Username is in use.');
}
else{
  usuario = document.getElementById('username').value;
  document.getElementById("logar_btn").disabled = true;
  document.getElementById("username").disabled = true;
  document.getElementById("message").disabled = false;
  document.getElementById("enviar").disabled = false;
  allowMessages();
  
}    
})();
}

    function allowMessages(){
     var socket = io.connect();

     socket.emit('sendmessage',{
       newconnection : true,
       user : usuario,
       message : `${usuario} entrou na sala.`
     } );

     $("#enviar").click(function() {
        const texto = $("#message").val();
        socket.emit('sendmessage', {
          newconnection : false,
          user: usuario,
          message : `${usuario}: ${texto}`
        });
        $("#message").val('');
     });

     socket.on('newmessage', function(data){
        $("#chat").append(data + '</br>')
     });
    }

    </script>
    <script src="/public/script.js"></script>
  </body>
</html>